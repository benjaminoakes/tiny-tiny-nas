#!/bin/sh
set -o errexit

source "/var/mnt/etc/get-podcasts.env"

# Fetch downloads given from a CSV
#
# Format: name,url
download_listed() {
  local first=1
  local name url
  
  # No parsing beyond splitting on comma
  while IFS=',' read name url; do
    # Skip header
    if [ 0 -eq $first ]; then
      wget "$url" -O "$name"
      # Force updated mtime
      touch "$name"
    fi
  
    first=0
  done
}

# There's a bug with `wget -q`, so we download to a file instead.
tmp_list="$PODCAST_TMP_DIR/rss.csv"
mkdir -p "$PODCAST_TMP_DIR"
wget -O "$tmp_list" "$PODCAST_CSV_URL"

mkdir -p $PODCAST_DESTINATION
# Get rid of the old ones
find "$PODCAST_DESTINATION" -type f -mtime +$PODCAST_MAX_AGE_DAYS -exec rm -rfv {} \;
cd "$PODCAST_DESTINATION"
# Download the new ones
download_listed < "$tmp_list"

rm -f "$tmp_list"
