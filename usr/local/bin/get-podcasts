#!/bin/sh
set -o errexit

source "/var/mnt/etc/get-podcasts.env"

# Fetch downloads given from a CSV
#
# Format: name,url
download_listed() {
  local first=1
  local name clean_name url
  
  # No parsing beyond splitting on comma
  while IFS=',' read name url; do
    clean_name=$(echo $name | sed 's/[?\/]/_/g')

    # Skip header
    if [ 0 -eq $first ]; then
      if [ -f "$clean_name" ]; then
        echo "File exists, skipping $clean_name"
      else
        wget "$url" -O "$clean_name"
        # Force updated mtime
        touch "$clean_name"
      fi
    fi
  
    first=0
  done
}

# There's a bug with `wget -q`, so we download to a file instead.
tmp_list="$PODCAST_TMP_DIR/rss.csv"
mkdir -p "$PODCAST_TMP_DIR"
wget -O "$tmp_list" "$PODCAST_CSV_URL"

mkdir -p "$PODCAST_DESTINATION"
# Get rid of the old ones
find "$PODCAST_DESTINATION" -type f -mtime +$PODCAST_MAX_AGE_DAYS -exec rm -rfv {} \;
cd "$PODCAST_DESTINATION"
# Download the new ones
download_listed < "$tmp_list"

rm -f "$tmp_list"
